<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-transitional-thymeleaf-4.dtd">
<div xmlns="http://www.w3.org/1999/xhtml"
     xmlns:th="http://www.thymeleaf.org"
     xmlns:dx="http://www.jahia.com/thymeleaf/dx"
     xmlns:dx-template="http://www.jahia.com/thymeleaf/template" th:with="firstName=sajid">
  <!--/*@thymesVar id="currentNode" type="org.jahia.services.content.JCRNodeWrapper"*/-->
  <!--/*@thymesVar id="out" type="java.io.PrintWriter"*/-->
  <!--/*@thymesVar id="script" type="org.jahia.services.render.scripting.Script"*/-->
  <!--/*@thymesVar id="scriptInfo" type="java.lang.String"*/-->
  <!--/*@thymesVar id="workspace" type="java.lang.String"*/-->
  <!--/*@thymesVar id="renderContext" type="org.jahia.services.render.RenderContext"*/-->
  <!--/*@thymesVar id="currentResource" type="org.jahia.services.render.Resource"*/-->
  <!--/*@thymesVar id="url" type="org.jahia.services.render.URLGenerator"*/-->
  <script type="text/javascript" th:src="${url.currentModule + '/javascript/lib/jquery.atmosphere.js'}"></script>
  <script type="text/javascript" th:src="${url.currentModule + '/javascript/lib/react-0.14.0.min.js'}"></script>
  <script type="text/javascript" th:src="${url.currentModule + '/javascript/lib/react-dom-0.14.0.min.js'}"></script>
  <script type="text/javascript" th:src="${url.currentModule + '/javascript/socketService.js'}"></script>
  <script type="text/javascript" th:src="${url.currentModule + '/javascript/react/application.js'}"></script>
  <dx:script>
    var InetAddress = Java.type("java.net.InetAddress");
    var JCRContentUtils = Java.type("org.jahia.services.content.JCRContentUtils");

    var title = currentNode.properties['jcr:title'].string;
    var nodes = JCRContentUtils.getChildrenOfType(currentNode, 'javaone:comment');
    var host = renderContext.request.serverName;
    var port = renderContext.request.serverPort;

    // Load scripts into Nashorn Global space to execute application.js Server Side
    load("http://" + InetAddress.localHost.hostName + ":" + port + url.currentModule + "/javascript/lib/react-0.14.0.min.js");
    load("http://" + InetAddress.localHost.hostName + ":" + port + url.currentModule + "/javascript/react/application.js");
    load("http://" + InetAddress.localHost.hostName + ":" + port + url.currentModule + "/javascript/jahiaService.js");

    // Create two arrays, one to be used on the serverside and the other on the client side.
    var items = [];
    // nodes is getting passed as an nodeiterator.  we are converting it to an array.
    for (var i in nodes) {
      var node = nodes[i];
      items.push(node.properties.text.string);
    }
    var renderedHtml = renderServer(title, items);
  </dx:script>
  <div th:id="comments-content" th:utext="${nashornGlobal.renderedHtml}"></div>
  <script type="text/javascript" th:inline="javascript">
    $(function () {
      var title = /*[[${nashornGlobal.title}]]*/ null;
      var items = /*[[${nashornGlobal.items.values}]]*/ "";
      var identifier = /*[[${currentNode.identifier}]]*/ null;
      var workspace = /*[[${workspace}]]*/ null;
      renderClient(title, items, identifier, workspace);
    });
  </script>
</div>  